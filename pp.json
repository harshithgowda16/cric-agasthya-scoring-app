{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string"
        },
        "adminPassword": {
            "type": "securestring"
        },
        "AzureUserName": {
            "type": "string"
        },
        "AzurePassword": {
            "type": "securestring"
        },
        "ODLID": {
            "type": "string"
        },
        "DeploymentID": {
            "type": "string"
        },
        "trainerUserName": {
            "type": "string"
        },
        "trainerUserPassword": {
            "type": "string"
        }
    },
    "variables": {
        "cloudlabsCommon": "[concat(' -AzureUserName ', parameters('AzureUserName'), ' -AzurePassword ', parameters('AzurePassword'), ' -AzureTenantID ', variables('AzureTenantID'), ' -AzureSubscriptionID ', variables('AzureSubscriptionID'), ' -ODLID ', parameters('ODLID'))]",
        "Enable-CloudLabsEmbeddedShadow": "[concat(' -vmAdminUsername ', parameters('adminUsername'), ' -trainerUserName ', parameters('trainerUserName'), ' -trainerUserPassword ', parameters('trainerUserPassword'))]",
        "AzureSubscriptionID": "[subscription().subscriptionId]",
        "AzureTenantID": "[subscription().tenantId]",
        "location": "[resourceGroup().location]",
        "rgName": "[resourceGroup().name]",

        "windowsVMSize": "Standard_F4s_v2",
        "ubuntuVMSize": "Standard_F4s_v2",

        "vm1ComputerName": "PRTGCore01",
        "vm2ComputerName": "PRTGRProbe",
        "vm3ComputerName": "LinuxProbe",
        "vm4ComputerName": "PRTGCore02",

        "vm1Name": "[concat('PRTGCore01-', parameters('DeploymentID'))]",
        "vm2Name": "[concat('PRTGRProbe-', parameters('DeploymentID'))]",
        "vm3Name": "[concat('LinuxProbe-', parameters('DeploymentID'))]",
        "vm4Name": "[concat('PRTGCore02-', parameters('DeploymentID'))]",

        "nic1": "[concat(variables('vm1Name'), '-nic')]",
        "nic2": "[concat(variables('vm2Name'), '-nic')]",
        "nic3": "[concat(variables('vm3Name'), '-nic')]",
        "nic4": "[concat(variables('vm4Name'), '-nic')]",

        "pip1": "[concat('pip1-', uniqueString(resourceGroup().id))]",
        "pip2": "[concat('pip2-', uniqueString(resourceGroup().id))]",
        "pip3": "[concat('pip3-', uniqueString(resourceGroup().id))]",
        "pip4": "[concat('pip4-', uniqueString(resourceGroup().id))]",

        "nsg1": "nsg-prtg-core-01",
        "nsg2": "nsg-prtg-remote-probe",
        "nsg3": "nsg-linux-probe",
        "nsg4": "nsg-prtg-core-02",

        "virtualNetworkName": "vnet",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
        "subnetRef": "[concat(variables('vnetID'), '/subnets/subnet')]",

        "customImageId": "/subscriptions/3ef9ec97-1a86-45d1-bc2a-7ccdd879020d/resourceGroups/cloudlabs-mgmt/providers/Microsoft.Compute/galleries/sharedimagegallary/images/win2025/versions/0.0.1"
    },
    "resources": [

        {
            "apiVersion": "2016-09-01",
            "name": "pid-e843308b-3ce2-42a2-b743-2f21b36a5e68",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },

        {
            "name": "[variables('virtualNetworkName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2018-02-01",
            "location": "[variables('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [ "10.0.0.0/16" ]
                },
                "subnets": [
                    {
                        "name": "subnet",
                        "properties": { "addressPrefix": "10.0.0.0/24" }
                    }
                ]
            }
        },

        {
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2020-08-01",
            "name": "[variables('pip1')]",
            "location": "[variables('location')]",
            "sku": { "name": "Standard", "tier": "Regional" },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIpAllocationMethod": "Static",
                "dnsSettings": { "domainNameLabel": "[variables('pip1')]" }
            }
        },
        {
            "name": "[variables('nsg1')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2017-06-01",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    { "name": "Port_80",           "properties": { "priority": 120,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "80"   } },
                    { "name": "Port_443",          "properties": { "priority": 130,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "443"  } },
                    { "name": "default-allow-rdp", "properties": { "priority": 1000, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "3389" } }
                ]
            }
        },
        {
            "name": "[variables('nic1')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2016-09-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/publicIpAddresses/', variables('pip1'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('nsg1'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": { "id": "[variables('subnetRef')]" },
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "10.0.0.4",
                            "publicIpAddress": { "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('pip1'))]" }
                        }
                    }
                ],
                "networkSecurityGroup": { "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg1'))]" }
            }
        },
        {
            "name": "[variables('vm1Name')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-11-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('nic1'))]"
            ],
            "properties": {
                "osProfile": {
                    "computerName": "[variables('vm1ComputerName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": { "provisionVmAgent": "true" }
                },
                "hardwareProfile": { "vmSize": "[variables('windowsVMSize')]" },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2025-datacenter-g2",
                        "version": "latest"
                    },
                    "osDisk": { "createOption": "fromImage", "managedDisk": { "storageAccountType": "StandardSSD_LRS" } },
                    "dataDisks": []
                },
                "networkProfile": {
                    "networkInterfaces": [ { "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic1'))]" } ]
                }
            },
            "resources": [
                {
                    "type": "extensions",
                    "name": "vmExtension1",
                    "apiVersion": "2015-06-15",
                    "location": "[variables('location')]",
                    "dependsOn": [ "[concat('Microsoft.Compute/virtualMachines/', variables('vm1Name'))]" ],
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.8",
                        "autoUpgradeMinorVersion": "true",
                        "settings": {
                            "fileUris": [
                                "https://experienceazure.blob.core.windows.net/templates/paessler/Lab1/psscript.ps1",
                                "https://experienceazure.blob.core.windows.net/templates/cloudlabs-common/cloudlabs-windows-functions.ps1"
                            ],
                            "commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File paessler/Lab1/psscript.ps1', variables('cloudlabsCommon'), variables('Enable-CloudLabsEmbeddedShadow'))]"
                        }
                    }
                }
            ]
        },

        {
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2020-08-01",
            "name": "[variables('pip2')]",
            "location": "[variables('location')]",
            "sku": { "name": "Standard", "tier": "Regional" },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIpAllocationMethod": "Static",
                "dnsSettings": { "domainNameLabel": "[variables('pip2')]" }
            }
        },
        {
            "name": "[variables('nsg2')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2017-06-01",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    { "name": "Port_80",           "properties": { "priority": 120,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "80"   } },
                    { "name": "Port_443",          "properties": { "priority": 130,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "443"  } },
                    { "name": "default-allow-rdp", "properties": { "priority": 1000, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "3389" } }
                ]
            }
        },
        {
            "name": "[variables('nic2')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2016-09-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/publicIpAddresses/', variables('pip2'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('nsg2'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": { "id": "[variables('subnetRef')]" },
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "10.0.0.5",
                            "publicIpAddress": { "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('pip2'))]" }
                        }
                    }
                ],
                "networkSecurityGroup": { "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg2'))]" }
            }
        },
        {
            "name": "[variables('vm2Name')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-11-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('nic2'))]"
            ],
            "properties": {
                "hardwareProfile": { "vmSize": "[variables('windowsVMSize')]" },
                "storageProfile": {
                    "imageReference": {
                        "id": "[variables('customImageId')]"
                    },
                    "osDisk": { "createOption": "fromImage", "managedDisk": { "storageAccountType": "StandardSSD_LRS" } },
                    "dataDisks": []
                },
                "networkProfile": {
                    "networkInterfaces": [ { "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic2'))]" } ]
                }
            },
            "resources": [
                {
                    "type": "extensions",
                    "name": "vmExtension2",
                    "apiVersion": "2015-06-15",
                    "location": "[variables('location')]",
                    "dependsOn": [ "[concat('Microsoft.Compute/virtualMachines/', variables('vm2Name'))]" ],
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.8",
                        "autoUpgradeMinorVersion": "true",
                        "settings": {
                            "fileUris": [
                                "https://experienceazure.blob.core.windows.net/templates/paessler/Lab1/psscript.ps1",
                                "https://experienceazure.blob.core.windows.net/templates/cloudlabs-common/cloudlabs-windows-functions.ps1"
                            ],
                            "commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File paessler/Lab1/psscript.ps1', variables('cloudlabsCommon'), variables('Enable-CloudLabsEmbeddedShadow'))]"
                        }
                    }
                }
            ]
        },

        {
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2020-08-01",
            "name": "[variables('pip3')]",
            "location": "[variables('location')]",
            "sku": { "name": "Standard", "tier": "Regional" },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIpAllocationMethod": "Static",
                "dnsSettings": { "domainNameLabel": "[variables('pip3')]" }
            }
        },
        {
            "name": "[variables('nsg3')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2017-06-01",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    { "name": "SSH",      "properties": { "priority": 110, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "22"  } },
                    { "name": "Port_80",  "properties": { "priority": 120, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "80"  } },
                    { "name": "Port_443", "properties": { "priority": 130, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "443" } }
                ]
            }
        },
        {
            "name": "[variables('nic3')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2016-09-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/publicIpAddresses/', variables('pip3'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('nsg3'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": { "id": "[variables('subnetRef')]" },
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "10.0.0.6",
                            "publicIpAddress": { "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/publicIpAddresses', variables('pip3'))]" }
                        }
                    }
                ],
                "networkSecurityGroup": { "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', variables('nsg3'))]" }
            }
        },
        {
            "name": "[variables('vm3Name')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2021-07-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('nic3'))]"
            ],
            "properties": {
                "hardwareProfile": { "vmSize": "[variables('ubuntuVMSize')]" },
                "storageProfile": {
                    "osDisk": {
                        "createOption": "fromImage",
                        "name": "[concat(variables('vm3Name'), '-osdisk')]",
                        "diskSizeGB": 128,
                        "managedDisk": { "storageAccountType": "StandardSSD_LRS" }
                    },
                    "imageReference": {
                        "publisher": "canonical",
                        "offer": "ubuntu-24_04-lts",
                        "sku": "server",
                        "version": "latest"
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [ { "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic3'))]" } ]
                },
                "osProfile": {
                    "computerName": "[variables('vm3ComputerName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": false,
                        "patchSettings": { "patchMode": "ImageDefault" }
                    }
                }
            }
        },

        {
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2020-08-01",
            "name": "[variables('pip4')]",
            "location": "[variables('location')]",
            "sku": { "name": "Standard", "tier": "Regional" },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIpAllocationMethod": "Static",
                "dnsSettings": { "domainNameLabel": "[variables('pip4')]" }
            }
        },
        {
            "name": "[variables('nsg4')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2017-06-01",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    { "name": "Port_80",           "properties": { "priority": 120,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "80"   } },
                    { "name": "Port_443",          "properties": { "priority": 130,  "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "443"  } },
                    { "name": "default-allow-rdp", "properties": { "priority": 1000, "protocol": "TCP", "access": "Allow", "direction": "Inbound", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*", "destinationPortRange": "3389" } }
                ]
            }
        },
        {
            "name": "[variables('nic4')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2016-09-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/publicIpAddresses/', variables('pip4'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('nsg4'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": { "id": "[variables('subnetRef')]" },
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "10.0.0.7",
                            "publicIpAddress": { "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('pip4'))]" }
                        }
                    }
                ],
                "networkSecurityGroup": { "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg4'))]" }
            }
        },
        {
            "name": "[variables('vm4Name')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-11-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('nic4'))]"
            ],
            "properties": {
                "osProfile": {
                    "computerName": "[variables('vm4ComputerName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": { "provisionVmAgent": "true" }
                },
                "hardwareProfile": { "vmSize": "[variables('windowsVMSize')]" },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2025-datacenter-g2",
                        "version": "latest"
                    },
                    "osDisk": { "createOption": "fromImage", "managedDisk": { "storageAccountType": "StandardSSD_LRS" } },
                    "dataDisks": []
                },
                "networkProfile": {
                    "networkInterfaces": [ { "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic4'))]" } ]
                }
            },
            "resources": [
                {
                    "type": "extensions",
                    "name": "vmExtension4",
                    "apiVersion": "2015-06-15",
                    "location": "[variables('location')]",
                    "dependsOn": [ "[concat('Microsoft.Compute/virtualMachines/', variables('vm4Name'))]" ],
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.8",
                        "autoUpgradeMinorVersion": "true",
                        "settings": {
                            "fileUris": [
                                "https://experienceazure.blob.core.windows.net/templates/paessler/Lab1/psscript.ps1",
                                "https://experienceazure.blob.core.windows.net/templates/cloudlabs-common/cloudlabs-windows-functions.ps1"
                            ],
                            "commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File paessler/Lab1/psscript.ps1', variables('cloudlabsCommon'), variables('Enable-CloudLabsEmbeddedShadow'))]"
                        }
                    }
                }
            ]
        }

    ],
    "outputs": {
        "DeploymentID": {
            "type": "string",
            "value": "[parameters('DeploymentID')]"
        },
        "VM1 PRTG-Core-Server-01 DNS Name": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pip1'))).dnsSettings.fqdn]"
        },
        "VM1 Admin Username": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        },
        "VM1 Admin Password": {
            "type": "string",
            "value": "[parameters('adminPassword')]"
        },
        "VM2 PRTG-Remote-Probe DNS Name": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pip2'))).dnsSettings.fqdn]"
        },
        "VM2 Admin Username": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        },
        "VM2 Admin Password": {
            "type": "string",
            "value": "[parameters('adminPassword')]"
        },
        "VM3 Linux Probe DNS Name": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pip3'))).dnsSettings.fqdn]"
        },
        "VM3 Admin Username": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        },
        "VM3 Admin Password": {
            "type": "string",
            "value": "[parameters('adminPassword')]"
        },
        "VM4 PRTG-Core-Server-02 DNS Name": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pip4'))).dnsSettings.fqdn]"
        },
        "VM4 Admin Username": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        },
        "VM4 Admin Password": {
            "type": "string",
            "value": "[parameters('adminPassword')]"
        }
    }
}
